<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ConfiguraÃ§Ãµes - SADA-ATA</title>
  <link rel="stylesheet" href="../styles/style.css">
  <link rel="stylesheet" href="../styles/configuracoes-style.css">
</head>
<body>
  <div class="container">
    <h1>âš™ï¸ ConfiguraÃ§Ãµes de Download</h1>

    <div id="mensagem" class="mensagem"></div>

    <!-- DiretÃ³rio de Download -->
    <div class="secao">
      <label>ğŸ“ DiretÃ³rio de Download</label>
      <div class="input-group">
        <input type="text" id="diretorio" placeholder="Selecione o diretÃ³rio..." readonly>
        <button class="btn-primario" onclick="selecionarDiretorio()">Selecionar Pasta</button>
      </div>
      <div class="info">
        ğŸ’¡ Escolha onde os arquivos das atas serÃ£o salvos
      </div>
    </div>

    <!-- Modo de OrganizaÃ§Ã£o -->
    <div class="secao">
      <label>ğŸ“‚ Modo de OrganizaÃ§Ã£o</label>
      <div class="opcoes-organizacao">
        
        <div class="opcao" onclick="selecionarOpcao('direto')">
          <input type="radio" name="organizacao" value="direto" id="opcao-direto">
          <div class="opcao-conteudo">
            <h3>Arquivos Diretos</h3>
            <p>Salva todos os arquivos diretamente na pasta escolhida, sem criar subpastas</p>
          </div>
        </div>

        <div class="opcao" onclick="selecionarOpcao('organizado')">
          <input type="radio" name="organizacao" value="organizado" id="opcao-organizado" checked>
          <div class="opcao-conteudo">
            <h3>Arquivos Organizados</h3>
            <p>Cria uma pasta numerada para cada ata (ex: 0001-idAta, 0002-idAta)</p>
          </div>
        </div>

        <div class="opcao" onclick="selecionarOpcao('ambos')">
          <input type="radio" name="organizacao" value="ambos" id="opcao-ambos">
          <div class="opcao-conteudo">
            <h3>Ambos</h3>
            <p>Salva arquivos diretos E organizados em pastas (duplica os arquivos)</p>
          </div>
        </div>

      </div>

      <div class="contador-info">
        <span>ğŸ“Š Contador atual de atas: <strong id="contador">0000</strong></span>
        <button class="btn-secundario" onclick="resetarContador()">Resetar Contador</button>
      </div>
    </div>

    <!-- BotÃµes de AÃ§Ã£o -->
    <div class="acoes">
      <button class="btn-primario" onclick="salvar()">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
    </div>

  </div>

  <script>
    // =============================================================================
    // â­ SISTEMA DE COMUNICAÃ‡ÃƒO COM JANELA PRINCIPAL
    // =============================================================================

    /**
     * HELPER: Envia mensagem para janela principal e aguarda resposta
     * 
     * Como funciona:
     * 1. Envia mensagem via postMessage para window.parent (janela principal)
     * 2. Cria uma Promise que aguarda a resposta
     * 3. Quando resposta chega, resolve a Promise
     * 
     * @param {string} tipo - Tipo da mensagem
     * @param {*} dados - Dados a enviar (opcional)
     * @returns {Promise} Promise que resolve com a resposta
     */
    function enviarMensagem(tipo, dados = null) {
      return new Promise((resolve, reject) => {
        // 1. Envia mensagem para janela pai
        // window.parent Ã© a janela que contÃ©m este iframe (index.html)
        window.parent.postMessage({
          tipo: tipo,
          dados: dados
        }, '*');

        // 2. Cria listener temporÃ¡rio para aguardar resposta
        const tipoResposta = `resposta-${tipo}`;
        
        // FunÃ§Ã£o que serÃ¡ chamada quando resposta chegar
        function aguardarResposta(evento) {
          // Verifica se Ã© a resposta que estamos esperando
          if (evento.data.tipo === tipoResposta) {
            // Remove o listener (nÃ£o precisa mais)
            window.removeEventListener('message', aguardarResposta);
            
            // Verifica se deu sucesso ou erro
            if (evento.data.sucesso) {
              resolve(evento.data.dados); // Sucesso!
            } else {
              reject(new Error(evento.data.erro)); // Erro!
            }
          }
        }

        // 3. Registra o listener
        window.addEventListener('message', aguardarResposta);

        // 4. Timeout de seguranÃ§a (se nÃ£o responder em 10s, cancela)
        setTimeout(() => {
          window.removeEventListener('message', aguardarResposta);
          reject(new Error('Timeout: sem resposta da janela principal'));
        }, 10000);
      });
    }

    // =============================================================================
    // FUNÃ‡Ã•ES DA PÃGINA
    // =============================================================================

    /**
     * Carrega configuraÃ§Ãµes ao iniciar
     */
    async function carregarConfiguracoes() {
      try {
        console.log('[Config] Carregando configuraÃ§Ãµes...');
        
        // Usa nossa funÃ§Ã£o helper para enviar mensagem e aguardar resposta
        // Ã‰ como fazer: await ipcRenderer.invoke('carregar-configuracoes')
        // Mas funciona dentro do iframe!
        const config = await enviarMensagem('carregar-configuracoes');
        
        console.log('[Config] ConfiguraÃ§Ãµes recebidas:', config);

        // Preenche diretÃ³rio
        if (config.diretorioDownload) {
          document.getElementById('diretorio').value = config.diretorioDownload;
        }

        // Seleciona modo de organizaÃ§Ã£o
        const modo = config.modoOrganizacao || 'organizado';
        document.getElementById(`opcao-${modo}`).checked = true;
        document.querySelector(`#opcao-${modo}`).parentElement.classList.add('selecionada');

        // Exibe contador
        const contador = (config.contadorAtas || 0).toString().padStart(4, '0');
        document.getElementById('contador').textContent = contador;

      } catch (erro) {
        console.error('[Config] Erro ao carregar configuraÃ§Ãµes:', erro);
        mostrarMensagem('âŒ Erro ao carregar configuraÃ§Ãµes', 'erro');
      }
    }

    /**
     * Seleciona opÃ§Ã£o de organizaÃ§Ã£o
     */
    function selecionarOpcao(opcao) {
      // Remove seleÃ§Ã£o de todas as opÃ§Ãµes
      document.querySelectorAll('.opcao').forEach(el => el.classList.remove('selecionada'));
      
      // Marca a opÃ§Ã£o escolhida
      document.getElementById(`opcao-${opcao}`).checked = true;
      document.getElementById(`opcao-${opcao}`).parentElement.classList.add('selecionada');
    }

    /**
     * Abre seletor de diretÃ³rio
     */
    async function selecionarDiretorio() {
      try {
        console.log('[Config] Abrindo seletor de diretÃ³rio...');
        
        // Envia mensagem para janela principal pedir seleÃ§Ã£o de diretÃ³rio
        const caminho = await enviarMensagem('selecionar-diretorio');
        
        // Se usuÃ¡rio escolheu um diretÃ³rio (nÃ£o cancelou)
        if (caminho) {
          document.getElementById('diretorio').value = caminho;
          console.log('[Config] DiretÃ³rio selecionado:', caminho);
        }
      } catch (erro) {
        console.error('[Config] Erro ao selecionar diretÃ³rio:', erro);
        mostrarMensagem('âŒ Erro ao selecionar diretÃ³rio', 'erro');
      }
    }

    /**
     * Salva configuraÃ§Ãµes
     */
    async function salvar() {
      const diretorio = document.getElementById('diretorio').value;
      
      // ValidaÃ§Ã£o bÃ¡sica
      if (!diretorio) {
        mostrarMensagem('âš ï¸ Por favor, selecione um diretÃ³rio', 'erro');
        return;
      }

      const modoSelecionado = document.querySelector('input[name="organizacao"]:checked').value;

      try {
        console.log('[Config] Salvando configuraÃ§Ãµes...');
        
        // Envia configuraÃ§Ãµes para serem salvas
        await enviarMensagem('salvar-configuracoes', {
          diretorioDownload: diretorio,
          modoOrganizacao: modoSelecionado
        });

        mostrarMensagem('âœ… ConfiguraÃ§Ãµes salvas com sucesso!', 'sucesso');
        
        // Recarrega para atualizar contador
        setTimeout(carregarConfiguracoes, 1000);

      } catch (erro) {
        console.error('[Config] Erro ao salvar:', erro);
        mostrarMensagem('âŒ Erro ao salvar configuraÃ§Ãµes', 'erro');
      }
    }

    /**
     * Reseta contador de atas
     */
    async function resetarContador() {
      if (!confirm('Deseja realmente resetar o contador de atas para 0000?')) {
        return; // UsuÃ¡rio cancelou
      }

      try {
        console.log('[Config] Resetando contador...');
        
        await enviarMensagem('resetar-contador');
        
        document.getElementById('contador').textContent = '0000';
        mostrarMensagem('âœ… Contador resetado!', 'sucesso');
      } catch (erro) {
        console.error('[Config] Erro ao resetar:', erro);
        mostrarMensagem('âŒ Erro ao resetar contador', 'erro');
      }
    }

    /**
     * Mostra mensagem de feedback
     */
    function mostrarMensagem(texto, tipo) {
      const mensagem = document.getElementById('mensagem');
      mensagem.textContent = texto;
      mensagem.className = `mensagem ${tipo}`;
      mensagem.style.display = 'block';
      
      // Remove mensagem apÃ³s 3 segundos
      setTimeout(() => {
        mensagem.style.display = 'none';
      }, 3000);
    }

    // =============================================================================
    // RECEBER MUDANÃ‡AS DE TEMA
    // =============================================================================

    /**
     * Escuta mensagens da janela principal
     * Especialmente mudanÃ§as de tema
     */
    window.addEventListener('message', (evento) => {
      if (evento.data.tipo === 'mudar-tema') {
        const tema = evento.data.tema;
        document.body.setAttribute('data-theme', tema);
        console.log('[Config] Tema alterado para:', tema);
      }
    });

    // =============================================================================
    // INICIALIZAÃ‡ÃƒO
    // =============================================================================

    // Carrega configuraÃ§Ãµes quando pÃ¡gina carregar
    window.addEventListener('DOMContentLoaded', carregarConfiguracoes);
  </script>
</body>
</html>